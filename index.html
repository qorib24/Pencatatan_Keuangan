
<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pencatatan Pembelian Paket Data</title>
    <!-- Import Tailwind CSS dari CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Import Font Awesome untuk ikon -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Import Chart.js untuk grafik -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <header class="bg-blue-600 text-white shadow-lg">
        <div class="container mx-auto px-4 py-6">
            <h1 class="text-3xl font-bold text-center">
                <i class="fas fa-mobile-alt mr-2"></i>
                Pencatatan Pembelian Paket Data
            </h1>
        </div>
    </header>

    <!-- Main Container -->
    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <!-- Filter Bulan dan Tahun untuk Statistik -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">
                <i class="fas fa-filter mr-2 text-blue-600"></i>
                Filter Statistik Bulanan
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="filterBulan" class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-calendar-alt mr-1"></i>Bulan
                    </label>
                    <select 
                        id="filterBulan" 
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    >
                        <option value="0">Januari</option>
                        <option value="1">Februari</option>
                        <option value="2">Maret</option>
                        <option value="3">April</option>
                        <option value="4">Mei</option>
                        <option value="5">Juni</option>
                        <option value="6">Juli</option>
                        <option value="7">Agustus</option>
                        <option value="8">September</option>
                        <option value="9">Oktober</option>
                        <option value="10">November</option>
                        <option value="11">Desember</option>
                    </select>
                </div>
                <div>
                    <label for="filterTahun" class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-calendar mr-1"></i>Tahun
                    </label>
                    <select 
                        id="filterTahun" 
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    >
                        <!-- Tahun akan diisi oleh JavaScript -->
                    </select>
                </div>
            </div>
        </div>

        <!-- Statistik Cards -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <!-- Total Pendapatan Bulan Ini -->
            <div class="bg-gradient-to-r from-green-400 to-green-600 rounded-lg shadow-md p-6 text-white">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-green-100 text-sm font-medium uppercase tracking-wide" id="labelPendapatan">Pendapatan Bulan Ini</p>
                        <p class="text-3xl font-bold cursor-pointer" id="totalPendapatan">Rp 0</p>
                    </div>
                    <div class="bg-green-500/20 rounded-full p-3">
                        <i class="fas fa-coins text-2xl"></i>
                    </div>
                </div>
            </div>

            <!-- Total Hutang Bulan Ini -->
            <div class="bg-gradient-to-r from-red-400 to-red-600 rounded-lg shadow-md p-6 text-white">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-red-100 text-sm font-medium uppercase tracking-wide" id="labelHutang">Hutang Bulan Ini</p>
                        <p class="text-3xl font-bold cursor-pointer" id="totalHutang">Rp 0</p>

                    </div>
                    <div class="bg-red-500/20 rounded-full p-3">
                        <i class="fas fa-exclamation-triangle text-2xl"></i>
                    </div>
                </div>
            </div>

            <!-- Total Transaksi Bulan Ini -->
            <div class="bg-gradient-to-r from-blue-400 to-blue-600 rounded-lg shadow-md p-6 text-white">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-blue-100 text-sm font-medium uppercase tracking-wide" id="labelTransaksi">Transaksi Bulan Ini</p>
                        <p class="text-3xl font-bold" id="totalTransaksi">0</p>
                    </div>
                    <div class="bg-blue-500/20 rounded-full p-3">
                        <i class="fas fa-chart-line text-2xl"></i>
                    </div>
                </div>
            </div>
        </div>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>

        <!-- Grafik Jumlah Pembeli Per Bulan -->
        <div class="bg-white rounded-xl shadow-lg p-8 mb-8 border border-gray-100">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-bold text-gray-800">
                    <i class="fas fa-chart-bar mr-3 text-purple-600"></i>
                    Jumlah Pembeli Per Bulan
                </h2>
                <div class="bg-purple-50 px-4 py-2 rounded-full">
                    <span class="text-purple-700 font-semibold text-sm" id="chartYear">Loading...</span>
                </div>
            </div>
            <div class="w-full overflow-x-auto">
  <div class="min-w-[640px] sm:min-w-full">
    <canvas id="monthlyChart" class="w-full h-[300px] sm:h-[400px]"></canvas>
  </div>
</div>
        <!-- Form Section -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <h2 class="text-2xl font-semibold text-gray-800 mb-6">
                <i class="fas fa-plus-circle mr-2 text-blue-600"></i>
                Tambah Data Pembelian
            </h2>
            
            <!-- Form Input -->
            <form id="formPaketData" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Input Nama -->
                <div class="space-y-2">
                    <label for="nama" class="block text-sm font-medium text-gray-700">
                        <i class="fas fa-user mr-1"></i>Nama Lengkap
                    </label>
                    <input 
                        type="text" 
                        id="nama" 
                        name="nama" 
                        required 
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="Masukkan nama lengkap"
                    >
                </div>

                <!-- Input Nomor HP -->
                <div class="space-y-2">
                    <label for="nomorHP" class="block text-sm font-medium text-gray-700">
                        <i class="fas fa-phone mr-1"></i>Nomor HP
                    </label>
                    <input 
                        type="tel" 
                        id="nomorHP" 
                        name="nomorHP" 
                        required 
                        pattern="[0-9]{10,13}"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="Contoh: 08123456789"
                    >
                </div>

                <!-- Input Harga -->
                <div class="space-y-2">
                    <label for="harga" class="block text-sm font-medium text-gray-700">
                        <i class="fas fa-money-bill-wave mr-1"></i>Harga Paket (Rp)
                    </label>
                    <input 
                        type="number" 
                        id="harga" 
                        name="harga" 
                        required 
                        min="0"
                        step="1000"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="Contoh: 25000"
                    >
                </div>

                <!-- Input Tanggal Pembelian -->
                <div class="space-y-2">
                    <label for="tanggalPembelian" class="block text-sm font-medium text-gray-700">
                        <i class="fas fa-calendar-alt mr-1"></i>Tanggal Pembelian
                    </label>
                    <input 
                        type="date" 
                        id="tanggalPembelian" 
                        name="tanggalPembelian" 
                        required 
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    >
                </div>

                <!-- Dropdown Status Pembayaran -->
                <div class="space-y-2 md:col-span-2">
                    <label for="statusPembayaran" class="block text-sm font-medium text-gray-700">
                        <i class="fas fa-credit-card mr-1"></i>Status Pembayaran
                    </label>
                    <select 
                        id="statusPembayaran" 
                        name="statusPembayaran" 
                        required 
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    >
                        <option value="">Pilih Status Pembayaran</option>
                        <option value="Bayar">Bayar</option>
                        <option value="Hutang">Hutang</option>
                    </select>
                </div>

                <!-- Tombol Submit -->
                <div class="md:col-span-2 pt-4">
                    <button 
                        type="submit" 
                        id="btnSubmit"
                        class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-md transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2"
                    >
                        <i class="fas fa-save mr-2"></i>
                        Simpan Data
                    </button>
                </div>
            </form>
        </div>

        <!-- Status/Loading Message -->
        <div id="statusMessage" class="hidden mb-6"></div>

        <!-- Pencarian -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">
                <i class="fas fa-search mr-2 text-blue-600"></i>
                Pencarian Data
            </h2>
            <div class="relative">
                <input 
                    type="text" 
                    id="searchInput" 
                    placeholder="Cari berdasarkan nama atau nomor HP..."
                    class="w-full px-4 py-3 pl-10 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                >
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                    <i class="fas fa-search text-gray-400"></i>
                </div>
                <button 
                    id="clearSearch" 
                    class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400 hover:text-gray-600 hidden"
                >
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div id="searchResults" class="mt-4 text-sm text-gray-600 hidden">
                <span id="searchCount">0</span> hasil ditemukan
            </div>
        </div>

        <!-- Tabel Data -->
        <div class="bg-white rounded-lg shadow-md overflow-hidden">
            <div class="px-6 py-4 bg-gray-50 border-b">
                <h2 class="text-2xl font-semibold text-gray-800">
                    <i class="fas fa-table mr-2 text-blue-600"></i>
                    Data Pembelian Paket Data
                </h2>
            </div>
            
            <!-- Loading indicator untuk tabel -->
            <div id="loadingTable" class="p-8 text-center">
                <i class="fas fa-spinner fa-spin text-blue-600 text-2xl mb-2"></i>
                <p class="text-gray-600">Memuat data...</p>
            </div>

            <!-- Container untuk tabel -->
            <div id="tableContainer" class="hidden">
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">No</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nomor HP</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Harga</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tanggal</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="dataTable" class="bg-white divide-y divide-gray-200">
                            <!-- Data akan diisi oleh JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Pesan jika tidak ada data -->
            <div id="noDataMessage" class="hidden p-8 text-center text-gray-500">
                <i class="fas fa-inbox text-4xl mb-4"></i>
                <p>Belum ada data pembelian paket data</p>
            </div>
        </div>
    </div>

    <!-- Modal Edit Status -->
    <div id="editModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-medium text-gray-900">
                        <i class="fas fa-edit mr-2 text-blue-600"></i>
                        Edit Data
                    </h3>
                    <button id="closeModal" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <!-- Modal Daftar Pelanggan -->

                
                <div class="mb-4">
                    <p class="text-sm text-gray-600 mb-2">Nama: <span id="editNama" class="font-medium"></span></p>
                    <p class="text-sm text-gray-600 mb-2">Nomor HP: <span id="editNomorHP" class="font-medium"></span></p>
                    <p class="text-sm text-gray-600 mb-4">Harga: <span id="editHarga" class="font-medium"></span></p>
                    
                    <label for="editStatus" class="block text-sm font-medium text-gray-700 mb-2">
                        Status Pembayaran:
                    </label>
                    <select 
                        id="editStatus" 
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    >
                        <option value="Bayar">Bayar</option>
                        <option value="Hutang">Hutang</option>
                    </select>
                </div>
                
                <div class="flex justify-end space-x-3">
                    <button 
                        id="cancelEdit" 
                        class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400 transition duration-200"
                    >
                        Batal
                    </button>
                    <button 
                        id="saveEdit" 
                        class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition duration-200"
                    >
                        <i class="fas fa-save mr-1"></i>
                        Simpan
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="statusListModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-lg shadow-lg max-w-2xl w-full p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold text-gray-800" id="modalTitle">Daftar Pelanggan</h3>
                    <button id="closeStatusListModal" class="text-gray-500 hover:text-gray-700">
                     <i class="fas fa-times text-lg"></i>
                </button>
            </div>
            <div id="statusListContent" class="max-h-96 overflow-y-auto">
      <!-- Daftar pelanggan akan muncul di sini -->
            </div>
        </div>
    </div>
    <!-- Footer -->
    <footer class="bg-gray-800 text-white text-center py-6 mt-12">
        <p>&copy; 2025 Sistem Pencatatan Paket Data. Dibuat Oleh Kati Cell</p>
    </footer>

    <script>
        // ==========================================
        // KONFIGURASI GOOGLE APPS SCRIPT
        // ==========================================
        // GANTI URL INI DENGAN URL GOOGLE APPS SCRIPT WEB APP ANDA
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzNCvw2ijNqkGEE3qRyXYgycouWo0zfUKXW53OzfEASPv1MJkO14xaMrXeTcAusBJovHg/exec";
        
        // ==========================================
        // VARIABEL GLOBAL
        // ==========================================
        let dataArray = []; // Array untuk menyimpan data lokal
        let filteredDataArray = []; // Array untuk menyimpan data yang telah difilter
        let editingIndex = -1; // Index data yang sedang diedit
        let monthlyChart = null; // Variable untuk chart bulanan

        // ==========================================
        // FUNGSI UNTUK FORMAT RUPIAH
        // ==========================================
        function formatRupiah(amount) {
            return new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR',
                minimumFractionDigits: 0
            }).format(amount);
        }

        // ==========================================
        // FUNGSI UNTUK MENGISI DROPDOWN TAHUN
        // ==========================================
        function populateYearDropdown() {
    const yearSelect = document.getElementById('filterTahun');
    const currentYear = new Date().getFullYear();
    
    // Bersihkan dropdown
    yearSelect.innerHTML = '';
    
    // Tambahkan tahun dari 5 tahun yang lalu sampai 2 tahun ke depan
    for (let year = currentYear - 5; year <= currentYear + 2; year++) {
        const option = document.createElement('option');
        option.value = year;
        option.textContent = year;
        if (year === currentYear) {
            option.selected = true;
        }
        yearSelect.appendChild(option);
    }
}

        // ==========================================
        // FUNGSI UNTUK MENDAPATKAN NAMA BULAN
        // ==========================================
        function getMonthName(monthIndex) {
            const months = [
                'Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni',
                'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'
            ];
            return months[monthIndex];
        }

        // ==========================================
        // FUNGSI UNTUK MENGHITUNG STATISTIK BERDASARKAN FILTER
        // ==========================================
        function calculateFilteredStats() {
    const selectedMonth = parseInt(document.getElementById('filterBulan').value);
    const selectedYear = parseInt(document.getElementById('filterTahun').value);

    let totalPendapatan = 0;
    let totalHutang = 0;
    let totalTransaksi = 0;

    // Reset filtered array
    filteredDataArray = [];

    dataArray.forEach(item => {
        const itemDate = new Date(item.tanggal);

        // Cek apakah transaksi sesuai bulan & tahun yang dipilih
        if (itemDate.getMonth() === selectedMonth && itemDate.getFullYear() === selectedYear) {
            filteredDataArray.push(item); // Simpan untuk grafik & tabel
            totalTransaksi++;

            if (item.status === 'Bayar') {
                totalPendapatan += parseFloat(item.harga || 0);
            } else if (item.status === 'Hutang') {
                totalHutang += parseFloat(item.harga || 0);
            }
        }
    });

    // Update nilai statistik ke tampilan
    document.getElementById('totalPendapatan').textContent = formatRupiah(totalPendapatan);
    document.getElementById('totalHutang').textContent = formatRupiah(totalHutang);
    document.getElementById('totalTransaksi').textContent = totalTransaksi;

    // Update label statistik
    const monthName = getMonthName(selectedMonth);
    const currentDate = new Date();
    const isCurrentMonth = selectedMonth === currentDate.getMonth() && selectedYear === currentDate.getFullYear();

    if (isCurrentMonth) {
        document.getElementById('labelPendapatan').textContent = 'Pendapatan Bulan Ini';
        document.getElementById('labelHutang').textContent = 'Hutang Bulan Ini';
        document.getElementById('labelTransaksi').textContent = 'Transaksi Bulan Ini';
    } else {
        document.getElementById('labelPendapatan').textContent = `Pendapatan ${monthName} ${selectedYear}`;
        document.getElementById('labelHutang').textContent = `Hutang ${monthName} ${selectedYear}`;
        document.getElementById('labelTransaksi').textContent = `Transaksi ${monthName} ${selectedYear}`;
    }

    // 🟡 Penting: Update tabel & grafik berdasarkan data yang terfilter
    renderTable();            // Tabel akan pakai filteredDataArray
    createMonthlyChart();     // Grafik pakai filteredDataArray
}


         function showStatusList(status) {
  const selectedMonth = parseInt(document.getElementById('filterBulan').value);
  const selectedYear = parseInt(document.getElementById('filterTahun').value);

  const listContainer = document.getElementById('statusListContent');
  const modalTitle = document.getElementById('modalTitle');

  // Filter data
  const filtered = dataArray.filter(item => {
    const date = new Date(item.tanggal);
    return (
      date.getMonth() === selectedMonth &&
      date.getFullYear() === selectedYear &&
      item.status === status
    );
  });

  modalTitle.textContent = `Daftar Customer dengan Status "${status}"`;

  if (filtered.length === 0) {
    listContainer.innerHTML = `<p class="text-gray-500 text-center">Tidak ada data ${status.toLowerCase()} bulan ini.</p>`;
  } else {
    const listHTML = `
      <table class="w-full text-sm text-left border">
        <thead class="bg-gray-100 text-gray-600">
          <tr>
            <th class="py-2 px-3">No</th>
            <th class="py-2 px-3">Nama</th>
            <th class="py-2 px-3">Nomor HP</th>
            <th class="py-2 px-3">Harga</th>
            <th class="py-2 px-3">Tanggal</th>
          </tr>
        </thead>
        <tbody>
          ${filtered.map((item, i) => `
            <tr class="border-t">
              <td class="py-2 px-3">${i + 1}</td>
              <td class="py-2 px-3">${item.nama}</td>
              <td class="py-2 px-3">${item.nomorHP}</td>
              <td class="py-2 px-3">${formatRupiah(item.harga)}</td>
              <td class="py-2 px-3">${new Date(item.tanggal).toLocaleDateString('id-ID')}</td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    `;
    listContainer.innerHTML = listHTML;
  }

  document.getElementById('statusListModal').classList.remove('hidden');
}

    function createMonthlyChart() {
  const ctx = document.getElementById('monthlyChart').getContext('2d');

  // Hapus chart lama jika ada
  if (monthlyChart) monthlyChart.destroy();

  const pembeliCounts = {};

  // Gunakan data yang sudah difilter berdasarkan bulan/tahun
  filteredDataArray.forEach(item => {
    const nama = item.nama;
    if (!pembeliCounts[nama]) pembeliCounts[nama] = 0;
    pembeliCounts[nama]++;
  });

  // Urutkan dan ambil 7 pembeli terbanyak
  const sorted = Object.entries(pembeliCounts)
    .sort((a, b) => b[1] - a[1])
    .slice(0, 7);

  const labels = sorted.map(([nama]) => nama);
  const data = sorted.map(([_, count]) => count);

  const colors = ['#3b82f6', '#f59e0b', '#10b981', '#ef4444', '#8b5cf6', '#ec4899', '#14b8a6'];

  monthlyChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [{
        label: 'Jumlah Pembelian',
        data: data,
        backgroundColor: colors,
        borderRadius: 6
      }]
    },
    options: {
      responsive: true,

      // ✅ Animasi
      animation: {
        duration: 1000,
        easing: 'easeOutBounce'
      },

      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: context => `${context.label}: ${context.parsed.y} pembelian`
          }
        },
        datalabels: {
          anchor: 'end',
          align: 'top',
          font: { weight: 'bold' },
          formatter: value => value
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          title: {
            display: true,
            text: 'Jumlah Pembelian',
            font: { size: 14, weight: 'bold' }
          }
        },
        x: {
          title: {
            display: true,
            text: 'Nama Pembeli',
            font: { size: 14, weight: 'bold' }
          }
        }
      }
    },
    plugins: [ChartDataLabels]
  });

  // Update label judul grafik
  const selectedMonth = parseInt(document.getElementById('filterBulan').value);
  const selectedYear = parseInt(document.getElementById('filterTahun').value);
  document.getElementById('chartYear').textContent = `Top 7 Pembeli - ${getMonthName(selectedMonth)} ${selectedYear}`;
}


        // ==========================================
        // FUNGSI UNTUK MENAMPILKAN STATUS MESSAGE
        // ==========================================
        function showStatus(message, type = 'success') {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.className = `mb-6 p-4 rounded-md ${type === 'success' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`;
            statusDiv.innerHTML = `
                <div class="flex items-center">
                    <i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-triangle'} mr-2"></i>
                    ${message}
                </div>
            `;
            statusDiv.classList.remove('hidden');
            
            // Hilangkan status setelah 3 detik
            setTimeout(() => {
                statusDiv.classList.add('hidden');
            }, 3000);
        }

        // ==========================================
        // FUNGSI UNTUK SUBMIT DATA KE GOOGLE SHEETS
        // ==========================================
       async function submitToGoogleSheets(data) {
    try {
        await fetch(GOOGLE_SCRIPT_URL, {
            method: 'POST',
            mode: 'no-cors',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                action: 'add',
                data: data
            })
        });

        // Dengan no-cors, kita anggap berhasil jika tidak ada error
        return { success: true, message: 'Data berhasil dikirim ke Google Sheets' };
        
    } catch (error) {
        console.error('Error submitting to Google Sheets:', error);
        return { success: false, message: 'Gagal mengirim data: ' + error.message };
    }
}

        // ==========================================
        // FUNGSI UNTUK MENGAMBIL DATA DARI GOOGLE SHEETS
        // ==========================================
       async function loadDataFromGoogleSheets() {
    try {
        // Untuk membaca data, kita HARUS bisa baca response, jadi tanpa no-cors
        const response = await fetch(`${GOOGLE_SCRIPT_URL}?action=read`);
        const result = await response.json();
        
        if (result.success) {
            dataArray = result.data || [];
            filteredDataArray = [...dataArray];
            renderTable();
            calculateFilteredStats();
            createMonthlyChart();
              // Event: klik pendapatan
document.getElementById('totalPendapatan').addEventListener('click', () => {
  showStatusList('Bayar');
});

// Event: klik hutang
document.getElementById('totalHutang').addEventListener('click', () => {
  showStatusList('Hutang');
});

// Event: tutup modal
document.getElementById('closeStatusListModal').addEventListener('click', () => {
  document.getElementById('statusListModal').classList.add('hidden');
});
            return { success: true };
        } else {
            throw new Error(result.message || 'Gagal mengambil data');
        }
    } catch (error) {
        console.error('Error loading data from Google Sheets:', error);
        // Jika gagal load dari server, coba load dari localStorage
        const localData = loadFromLocalStorage();
        if (localData.length > 0) {
            dataArray = localData;
            filteredDataArray = [...dataArray];
            renderTable();
            calculateFilteredStats();
            createMonthlyChart();
            showStatus('Data dimuat dari penyimpanan lokal', 'success');
        }
        return { success: false, message: error.message };
    }
}

        // ==========================================
        // FUNGSI UNTUK UPDATE DATA DI GOOGLE SHEETS
        // ==========================================
        async function updateDataInGoogleSheets(index, updatedData) {
    try {
        await fetch(GOOGLE_SCRIPT_URL, {
            method: 'POST',
            mode: 'no-cors',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                action: 'update',
                index: index,
                data: updatedData
            })
        });

        return { success: true, message: 'Data berhasil diupdate' };
        
    } catch (error) {
        console.error('Error updating data in Google Sheets:', error);
        return { success: false, message: 'Gagal mengupdate data: ' + error.message };
    }
}

        // ==========================================
        // FUNGSI UNTUK HAPUS DATA DI GOOGLE SHEETS
        // ==========================================
        async function deleteDataFromGoogleSheets(index) {
    try {
        await fetch(GOOGLE_SCRIPT_URL, {
            method: 'POST',
            mode: 'no-cors',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                action: 'delete',
                index: index
            })
        });

        return { success: true, message: 'Data berhasil dihapus' };
        
    } catch (error) {
        console.error('Error deleting data from Google Sheets:', error);
        return { success: false, message: 'Gagal menghapus data: ' + error.message };
    }
}

        // ==========================================
        // FUNGSI UNTUK RENDER TABEL
        // ==========================================
        function renderTable() {
            const tableBody = document.getElementById('dataTable');
            const loadingTable = document.getElementById('loadingTable');
            const tableContainer = document.getElementById('tableContainer');
            const noDataMessage = document.getElementById('noDataMessage');

            // Sembunyikan loading
            loadingTable.classList.add('hidden');

            if (filteredDataArray.length === 0) {
                tableContainer.classList.add('hidden');
                noDataMessage.classList.remove('hidden');
                return;
            }

            // Tampilkan tabel dan sembunyikan pesan kosong
            tableContainer.classList.remove('hidden');
            noDataMessage.classList.add('hidden');

            // Bersihkan tabel
            tableBody.innerHTML = '';

            // Render data
            filteredDataArray.forEach((item, index) => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 transition-colors duration-200';
                
                const statusClass = item.status === 'Bayar' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
                const statusIcon = item.status === 'Bayar' ? 'fa-check-circle' : 'fa-exclamation-triangle';
                
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${index + 1}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-medium text-gray-900">${item.nama}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item.nomorHP}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${formatRupiah(parseFloat(item.harga))}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${new Date(item.tanggal).toLocaleDateString('id-ID')}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${statusClass}">
                            <i class="fas ${statusIcon} mr-1"></i>
                            ${item.status}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2">
                        <button 
                            onclick="editData(${dataArray.indexOf(item)})" 
                            class="text-blue-600 hover:text-blue-900 transition-colors duration-200"
                            title="Edit"
                        >
                            <i class="fas fa-edit"></i>
                        </button>
                        <button 
                            onclick="deleteData(${dataArray.indexOf(item)})" 
                            class="text-red-600 hover:text-red-900 transition-colors duration-200"
                            title="Hapus"
                        >
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                
                tableBody.appendChild(row);
            });
        }

        // ==========================================
        // FUNGSI UNTUK PENCARIAN
        // ==========================================
       function performSearch() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
    const clearButton = document.getElementById('clearSearch');
    const searchResults = document.getElementById('searchResults');
    const searchCount = document.getElementById('searchCount');
    const rows = document.querySelectorAll('#dataTable tr');

    let count = 0;
    rows.forEach(row => {
        const nama = row.cells[1]?.textContent?.toLowerCase() || '';
        const hp   = row.cells[2]?.textContent || '';
        if (nama.includes(searchTerm) || hp.includes(searchTerm)) {
            row.style.display = '';
            count++;
        } else {
            row.style.display = 'none';
        }
    });

    if (searchTerm === '') {
        clearButton.classList.add('hidden');
        searchResults.classList.add('hidden');
    } else {
        clearButton.classList.remove('hidden');
        searchResults.classList.remove('hidden');
        searchCount.textContent = count;
    }
}


        // ==========================================
        // FUNGSI UNTUK CLEAR PENCARIAN
        // ==========================================
        function clearSearch() {
            document.getElementById('searchInput').value = '';
            performSearch();
        }

        // ==========================================
        // FUNGSI UNTUK EDIT DATA
        // ==========================================
        function editData(index) {
            editingIndex = index;
            const item = dataArray[index];
            
            // Isi modal dengan data
            document.getElementById('editNama').textContent = item.nama;
            document.getElementById('editNomorHP').textContent = item.nomorHP;
            document.getElementById('editHarga').textContent = formatRupiah(parseFloat(item.harga));
            document.getElementById('editStatus').value = item.status;
            
            // Tampilkan modal
            document.getElementById('editModal').classList.remove('hidden');
        }

        // ==========================================
        // FUNGSI UNTUK HAPUS DATA
        // ==========================================
        async function deleteData(index) {
            if (confirm('Apakah Anda yakin ingin menghapus data ini?')) {
                const deleteBtn = event.target;
                const originalContent = deleteBtn.innerHTML;
                
                // Tampilkan loading
                deleteBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                deleteBtn.disabled = true;

                try {
                    const result = await deleteDataFromGoogleSheets(index);
                    
                    if (result.success) {
                        // Hapus dari array lokal
                        dataArray.splice(index, 1);
                        filteredDataArray = [...dataArray];
                        
                        // Update tampilan
                        renderTable();
                        calculateFilteredStats();
                        createMonthlyChart();
                        
                        showStatus('Data berhasil dihapus!', 'success');
                    } else {
                        showStatus(result.message, 'error');
                    }
                } catch (error) {
                    showStatus('Terjadi kesalahan saat menghapus data', 'error');
                }
                
                // Kembalikan tombol
                deleteBtn.innerHTML = originalContent;
                deleteBtn.disabled = false;
            }
        }

        // ==========================================
        // FUNGSI UNTUK SAVE EDIT
        // ==========================================
        async function saveEdit() {
            const newStatus = document.getElementById('editStatus').value;
            const saveBtn = document.getElementById('saveEdit');
            const originalContent = saveBtn.innerHTML;
            
            // Tampilkan loading
            saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>Menyimpan...';
            saveBtn.disabled = true;

            try {
                const updatedData = {
                    ...dataArray[editingIndex],
                    status: newStatus
                };

                const result = await updateDataInGoogleSheets(editingIndex, updatedData);
                
                if (result.success) {
                    // Update data lokal
                    dataArray[editingIndex].status = newStatus;
                    filteredDataArray = [...dataArray];
                    
                    // Update tampilan
                    renderTable();
                    calculateFilteredStats();
                    createMonthlyChart();
                    
                    // Tutup modal
                    document.getElementById('editModal').classList.add('hidden');
                    
                    showStatus('Data berhasil diupdate!', 'success');
                } else {
                    showStatus(result.message, 'error');
                }
            } catch (error) {
                showStatus('Terjadi kesalahan saat mengupdate data', 'error');
            }
            
            // Kembalikan tombol
            saveBtn.innerHTML = originalContent;
            saveBtn.disabled = false;
        }

        // ==========================================
        // EVENT LISTENERS
        // ==========================================
        document.addEventListener('DOMContentLoaded', function() {
            // Set tanggal hari ini sebagai default
            document.getElementById('tanggalPembelian').value = new Date().toISOString().split('T')[0];
            
            // Set bulan dan tahun saat ini sebagai default untuk filter
            const currentDate = new Date();
            document.getElementById('filterBulan').value = currentDate.getMonth();
            
            // Isi dropdown tahun
            populateYearDropdown();
            
            // Load data dari Google Sheets
            loadDataFromGoogleSheets();

            // Form submit event
            document.getElementById('formPaketData').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const formData = new FormData(e.target);
                const data = {
                    nama: formData.get('nama'),
                    nomorHP: formData.get('nomorHP'),
                    harga: parseFloat(formData.get('harga')),
                    tanggal: formData.get('tanggalPembelian'),
                    status: formData.get('statusPembayaran')
                };

                const submitBtn = document.getElementById('btnSubmit');
                const originalContent = submitBtn.innerHTML;
                
                // Tampilkan loading
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Menyimpan...';
                submitBtn.disabled = true;

                try {
                    const result = await submitToGoogleSheets(data);
                    
                    if (result.success) {
                        // Tambahkan ke array lokal
                        dataArray.push(data);
                        filteredDataArray = [...dataArray];
                        
                        // Update tampilan
                        renderTable();
                        calculateFilteredStats();
                        createMonthlyChart();
                        
                        // Reset form
                        e.target.reset();
                        document.getElementById('tanggalPembelian').value = new Date().toISOString().split('T')[0];
                        
                        showStatus('Data berhasil disimpan!', 'success');
                    } else {
                        showStatus(result.message, 'error');
                    }
                } catch (error) {
                    showStatus('Terjadi kesalahan saat menyimpan data', 'error');
                }
                
                // Kembalikan tombol
                submitBtn.innerHTML = originalContent;
                submitBtn.disabled = false;
            });

            // Search functionality
            const searchInput = document.getElementById('searchInput');
            searchInput.addEventListener('input', performSearch);
            
            document.getElementById('clearSearch').addEventListener('click', clearSearch);

            // Filter change events
            document.getElementById('filterBulan').addEventListener('change', calculateFilteredStats);
            document.getElementById('filterTahun').addEventListener('change', calculateFilteredStats);

            // Modal events
            document.getElementById('closeModal').addEventListener('click', function() {
                document.getElementById('editModal').classList.add('hidden');
            });
            
            document.getElementById('cancelEdit').addEventListener('click', function() {
                document.getElementById('editModal').classList.add('hidden');
            });
            
            document.getElementById('saveEdit').addEventListener('click', saveEdit);

            // Close modal when clicking outside
            document.getElementById('editModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    this.classList.add('hidden');
                }
            });
        });
    </script>
</body>
</html>
