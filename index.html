

<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pencatatan Pembelian Paket Data</title>
    <!-- Import Tailwind CSS dari CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Import Font Awesome untuk ikon -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Import Chart.js untuk grafik -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <!-- Tambahkan ini di bagian <head> -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- jsPDF & autoTable -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
<script>
  const firebaseConfig = {
    apiKey: "AIzaSyA8Hkwb-PYMeTdCwY0wfP3UVv7MFnGFZdE",
    authDomain: "catatan-9a225.firebaseapp.com",
    databaseURL: "https://catatan-9a225-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "catatan-9a225",
    storageBucket: "catatan-9a225.appspot.com",
    messagingSenderId: "989304269442",
    appId: "1:989304269442:web:e90f948a5f8b2bd795a29b",
    measurementId: "G-PCEN5GK1EM"
  };

  // Inisialisasi Firebase
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();
</script>
</head>
<section id="dashboardSection">
<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <header class="bg-blue-600 text-white shadow-lg">
        <div class="container mx-auto px-4 py-6">
            <h1 class="text-3xl font-bold text-center">
                <i class="fas fa-mobile-alt mr-2"></i>
                Pencatatan Pembelian Paket Data
            </h1>
        </div>
    </header>
    

    <!-- Main Container -->
    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <!-- Filter Bulan dan Tahun untuk Statistik -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">
                <i class="fas fa-filter mr-2 text-blue-600"></i>
                Filter Statistik Bulanan
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="filterBulan" class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-calendar-alt mr-1"></i>Bulan
                    </label>
                    <select 
                        id="filterBulan" 
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    >
                        <option value="0">Januari</option>
                        <option value="1">Februari</option>
                        <option value="2">Maret</option>
                        <option value="3">April</option>
                        <option value="4">Mei</option>
                        <option value="5">Juni</option>
                        <option value="6">Juli</option>
                        <option value="7">Agustus</option>
                        <option value="8">September</option>
                        <option value="9">Oktober</option>
                        <option value="10">November</option>
                        <option value="11">Desember</option>
                    </select>
                </div>
                <div>
                    <label for="filterTahun" class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-calendar mr-1"></i>Tahun
                    </label>
                    <select 
                        id="filterTahun" 
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    >
                        <!-- Tahun akan diisi oleh JavaScript -->
                    </select>
                </div>
            </div>
        </div>
        <div class="flex justify-end mb-6">
  <button onclick="showSection('data')"
    class="inline-flex items-center px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg shadow hover:bg-blue-700 transition duration-300">
    <i class="fas fa-database mr-2"></i> Lihat Data Pembelian
  </button>
</div>


        <!-- Statistik Cards -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <!-- Total Pendapatan Bulan Ini -->
            <div class="bg-gradient-to-r from-green-400 to-green-600 rounded-lg shadow-md p-6 text-white">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-green-100 text-sm font-medium uppercase tracking-wide" id="labelPendapatan">Pendapatan Bulan Ini</p>
                        <p class="text-3xl font-bold cursor-pointer" id="totalPendapatan">Rp 0</p>
                    </div>
                    <div class="bg-green-500/20 rounded-full p-3">
                        <i class="fas fa-coins text-2xl"></i>
                    </div>
                </div>
            </div>

            <!-- Total Hutang Bulan Ini -->
            <div class="bg-gradient-to-r from-red-400 to-red-600 rounded-lg shadow-md p-6 text-white">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-red-100 text-sm font-medium uppercase tracking-wide" id="labelHutang">Hutang Bulan Ini</p>
                        <p class="text-3xl font-bold cursor-pointer" id="totalHutang">Rp 0</p>

                    </div>
                    <div class="bg-red-500/20 rounded-full p-3">
                        <i class="fas fa-exclamation-triangle text-2xl"></i>
                    </div>
                </div>
            </div>

            <!-- Total Transaksi Bulan Ini -->
            <div class="bg-gradient-to-r from-blue-400 to-blue-600 rounded-lg shadow-md p-6 text-white">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-blue-100 text-sm font-medium uppercase tracking-wide" id="labelTransaksi">Transaksi Bulan Ini</p>
                        <p class="text-3xl font-bold" id="totalTransaksi">0</p>
                    </div>
                    <div class="bg-blue-500/20 rounded-full p-3">
                        <i class="fas fa-chart-line text-2xl"></i>
                    </div>
                </div>
            </div>
        </div>

<div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8">
  <button onclick="tampilkanDaftarDashboard('Bayar')" class="bg-green-100 hover:bg-green-200 text-green-800 font-semibold py-2 px-4 rounded-lg shadow">
    <i class="fas fa-users mr-2"></i> Lihat Daftar Customer yang Bayar
  </button>
  <button onclick="tampilkanDaftarDashboard('Hutang')" class="bg-red-100 hover:bg-red-200 text-red-800 font-semibold py-2 px-4 rounded-lg shadow">
    <i class="fas fa-users-slash mr-2"></i> Lihat Daftar Customer yang Hutang
  </button>
</div>

<div id="listBayarDashboard" class="mt-6 hidden bg-white shadow rounded-lg p-4"></div>
<!-- Wadah Daftar Customer Hutang -->
<div id="listHutangDashboard" class="mt-6 hidden bg-white shadow rounded-lg p-4"></div>

<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>

        <!-- Grafik Jumlah Pembeli Per Bulan -->
        <div class="bg-white rounded-xl shadow-lg p-8 mb-8 border border-gray-100">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-bold text-gray-800">
                    <i class="fas fa-chart-bar mr-3 text-purple-600"></i>
                    Jumlah Pembeli Per Bulan
                </h2>
                <div class="bg-purple-50 px-4 py-2 rounded-full">
                    <span class="text-purple-700 font-semibold text-sm" id="chartYear">Loading...</span>
                </div>
            </div>
            <div class="w-full overflow-x-auto">
  <div class="min-w-[640px] sm:min-w-full">
    <canvas id="monthlyChart" class="w-full h-[300px] sm:h-[400px]"></canvas>
  </div>
</div>
        <!-- Form Section -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <h2 class="text-2xl font-semibold text-gray-800 mb-6">
                <i class="fas fa-plus-circle mr-2 text-blue-600"></i>
                Tambah Data Pembelian
            </h2>
            
            <!-- Form Input -->
            <!-- Form Container yang responsif -->
<!-- ✅ FORM TANPA GRID LUAR -->
<div class="p-4">
  <form id="formPaketData" class="flex flex-col gap-6">

    <!-- Input Nama -->
    <div class="space-y-2">
      <label for="nama" class="block text-sm font-medium text-gray-700">
        <i class="fas fa-user mr-1"></i>Nama Lengkap
      </label>
      <input type="text" id="nama" name="nama" required placeholder="Contoh: Joko" class="w-full px-3 py-2 border border-gray-300 rounded-md">
    </div>

    <!-- Input Nomor HP -->
    <div class="space-y-2">
      <label for="nomorHP" class="block text-sm font-medium text-gray-700">
        <i class="fas fa-phone mr-1"></i>Nomor HP
      </label>
      <input type="tel" id="nomorHP" name="nomorHP" required pattern="[0-9]{10,13}" placeholder="Contoh: 081234567890" class="w-full px-3 py-2 border border-gray-300 rounded-md">
    </div>

    <!-- Dropdown Jenis Paket -->
    <div class="space-y-2">
      <label for="jenisPaket" class="block text-sm font-medium text-gray-700">
        <i class="fas fa-box mr-1"></i>Jenis Paket
      </label>
      <select id="jenisPaket" name="jenisPaket" required class="w-full px-3 py-2 border border-gray-300 rounded-md">
        <option value="">Pilih Jenis Paket</option>
        <option value="VPN">VPN</option>
        <option value="Reguler">Reguler</option>
      </select>
    </div>

    <!-- Input Harga -->
    <div class="space-y-2">
      <label for="harga" class="block text-sm font-medium text-gray-700">
        <i class="fas fa-money-bill-wave mr-1"></i>Harga Paket (Rp)
      </label>
      <input type="number" id="harga" name="harga" required min="0" step="1000" placeholder="Contoh: 25000" class="w-full px-3 py-2 border border-gray-300 rounded-md">
    </div>

    <!-- Input Tanggal -->
    <div class="space-y-2">
      <label for="tanggalPembelian" class="block text-sm font-medium text-gray-700">
        <i class="fas fa-calendar-alt mr-1"></i>Tanggal Pembelian
      </label>
      <input type="date" id="tanggalPembelian" name="tanggalPembelian" required class="w-full px-3 py-2 border border-gray-300 rounded-md">
    </div>

    <!-- Status Pembayaran -->
    <div class="space-y-2">
      <label for="statusPembayaran" class="block text-sm font-medium text-gray-700">
        <i class="fas fa-credit-card mr-1"></i>Status Pembayaran
      </label>
      <select id="statusPembayaran" name="statusPembayaran" required class="w-full px-3 py-2 border border-gray-300 rounded-md">
        <option value="">Pilih Status Pembayaran</option>
        <option value="Bayar">Bayar</option>
        <option value="Hutang">Hutang</option>
      </select>
    </div>

   <!-- Tombol Submit -->
<div class="pt-4">
  <button type="submit" id="btnSubmit" class="relative w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-md transition duration-300 ease-in-out overflow-hidden">
    <span id="btnText" class="flex items-center justify-center">
      <i class="fas fa-save mr-2"></i>Simpan Data
    </span>
    <span id="btnLoading" class="hidden flex items-center justify-center">
      <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
      </svg>
      Menyimpan...
    </span>
  </button>
</div>
  </form>
</div>
</section>

<section id="dataSection" style="display: none;">

        <!-- Status/Loading Message -->
        <div id="statusMessage" class="hidden mb-6"></div>

        <!-- Pencarian -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">
                <i class="fas fa-search mr-2 text-blue-600"></i>
                Pencarian Data
            </h2>
            <div class="relative">
                <input 
                    type="text" 
                    id="searchInput" 
                    placeholder="Cari berdasarkan nama atau nomor HP..."
                    class="w-full px-4 py-3 pl-10 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                >
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                    <i class="fas fa-search text-gray-400"></i>
                </div>
                <input type="checkbox" id="searchAll" class="form-checkbox text-blue-600">
  <label for="searchAll" class="text-sm text-gray-700">Cari di semua data (abaikan filter bulan/tahun)</label>
</div>
                <button 
                    id="clearSearch" 
                    class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400 hover:text-gray-600 hidden"
                >
                <div class="mt-3 flex items-center space-x-2">

                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div id="searchResults" class="mt-4 text-sm text-gray-600 hidden">
                <span id="searchCount">0</span> hasil ditemukan
            </div>
        </div>
<div class="bg-white rounded-lg shadow-md p-6 my-6">
  <h2 class="text-xl font-semibold text-gray-800 mb-4">
    <i class="fas fa-chart-pie mr-2 text-purple-600"></i>
    Grafik Jenis Paket - Bulan Terpilih
  </h2>
  <div class="w-full max-w-md mx-auto">
  <canvas id="pieJenisPaketChart" class="w-full h-auto"></canvas>
</div>

</div>

        <!-- Tabel Data -->
        <div class="bg-white rounded-lg shadow-md overflow-hidden">
            <div class="px-6 py-4 bg-gray-50 border-b">
                <h2 class="text-2xl font-semibold text-gray-800">
                    <i class="fas fa-table mr-2 text-blue-600"></i>
                    Data Pembelian Paket Data
                </h2>
                
            </div> 
            <div class="flex justify-end mt-4 px-6">
  <button onclick="exportToPDF()" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded shadow">
    <i class="fas fa-file-pdf mr-2"></i> Export PDF
  </button>
</div>
     
            <!-- Loading indicator untuk tabel -->
            <div id="loadingTable" class="p-8 text-center">
                <i class="fas fa-spinner fa-spin text-blue-600 text-2xl mb-2"></i>
                <p class="text-gray-600">Memuat data...</p>
            </div>

            <!-- Container untuk tabel -->
            <div id="tableContainer" class="hidden">
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">No</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nomor HP</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">jenis Paket</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Harga</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tanggal</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="dataTable" class="bg-white divide-y divide-gray-200">
                            <!-- Data akan diisi oleh JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Pesan jika tidak ada data -->
            <div id="noDataMessage" class="hidden p-8 text-center text-gray-500">
                <i class="fas fa-inbox text-4xl mb-4"></i>
                <p>Belum ada data pembelian paket data</p>
            </div>
        </div>
    </div>

    <!-- Modal Edit Status -->
    <div id="editModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-medium text-gray-900">
                        <i class="fas fa-edit mr-2 text-blue-600"></i>
                        Edit Data
                    </h3>
                    <button id="closeModal" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <!-- Modal Daftar Pelanggan -->

                
                <div class="mb-4">
                    <p class="text-sm text-gray-600 mb-2">Nama: <span id="editNama" class="font-medium"></span></p>
                    <p class="text-sm text-gray-600 mb-2">Nomor HP: <span id="editNomorHP" class="font-medium"></span></p>
                    <p class="text-sm text-gray-600 mb-4">Harga: <span id="editHarga" class="font-medium"></span></p>
                    
                    <label for="editStatus" class="block text-sm font-medium text-gray-700 mb-2">
                        Status Pembayaran:
                    </label>
                    <select 
                        id="editStatus" 
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    >
                        <option value="Bayar">Bayar</option>
                        <option value="Hutang">Hutang</option>
                    </select>
                </div>
                
                <div class="flex justify-end space-x-3">
                    <button 
                        id="cancelEdit" 
                        class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400 transition duration-200"
                    >
                        Batal
                    </button>
                    <button 
                        id="saveEdit" 
                        class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition duration-200"
                    >
                        <i class="fas fa-save mr-1"></i>
                        Simpan
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="statusListModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-lg shadow-lg max-w-2xl w-full p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold text-gray-800" id="modalTitle">Daftar Pelanggan</h3>
                    <button id="closeStatusListModal" class="text-gray-500 hover:text-gray-700">
                     <i class="fas fa-times text-lg"></i>
                </button>
            </div>
            <div id="statusListContent" class="max-h-96 overflow-y-auto">
      <!-- Daftar pelanggan akan muncul di sini -->
            </div>
        </div>
    </div>
    </section>
    <!-- Footer -->
    <footer class="bg-gray-800 text-white text-center py-6 mt-12">
        <p>&copy; 2025 Sistem Pencatatan Paket Data. Dibuat Oleh Kati Cell</p>
    </footer>

    <script>
        // ==========================================
        // VARIABEL GLOBAL
        // ==========================================
        let dataArray = []; // Array untuk menyimpan data lokal
        let filteredDataArray = []; // Array untuk menyimpan data yang telah difilter
        let editingIndex = -1; // Index data yang sedang diedit
        let monthlyChart = null; // Variable untuk chart bulanan

        // ==========================================
        // FUNGSI UNTUK FORMAT RUPIAH
        // ==========================================
        function formatRupiah(amount) {
            return new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR',
                minimumFractionDigits: 0
            }).format(amount);
        }

        // ==========================================
        // FUNGSI UNTUK MENGISI DROPDOWN TAHUN
        // ==========================================
   
function populateYearDropdown() {
    const yearSelect = document.getElementById('filterTahun');
    const currentYear = new Date().getFullYear();

    // Bersihkan dropdown tahun
    yearSelect.innerHTML = '';

    // Tambahkan tahun dari 5 tahun yang lalu sampai 2 tahun ke depan
    for (let year = currentYear - 5; year <= currentYear + 2; year++) {
        const option = document.createElement('option');
        option.value = year;
        option.textContent = year;
        if (year === currentYear) {
            option.selected = true;
        }
        yearSelect.appendChild(option);
    }

    // Atur bulan sekarang ke dropdown bulan
    document.getElementById('filterBulan').value = new Date().getMonth();
}

function loadDataFromFirebase() {
    db.ref("pembelian").once("value").then(snapshot => {
        dataArray = [];
        snapshot.forEach(child => {
            dataArray.push({ ...child.val(), key: child.key });
        });
        calculateFilteredStats(); // Tampilkan data setelah ambil
    });
}

window.addEventListener("DOMContentLoaded", () => {
    populateYearDropdown(); // isi dropdown tahun & bulan

    loadDataFromFirebase(); // ambil data dari Firebase
    calculateFilteredStats(); // tampilkan statistik awal

    // Aktifkan pemicu filter ketika user ganti bulan/tahun
    document.getElementById('filterBulan').addEventListener('change', calculateFilteredStats);
    document.getElementById('filterTahun').addEventListener('change', calculateFilteredStats);
});


        // ==========================================
        // FUNGSI UNTUK MENDAPATKAN NAMA BULAN
        // ==========================================
        function getMonthName(monthIndex) {
            const months = [
                'Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni',
                'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'
            ];
            return months[monthIndex];
        }

        // ==========================================
        // FUNGSI UNTUK MENGHITUNG STATISTIK BERDASARKAN FILTER
        // ==========================================
        function calculateFilteredStats() {
    const selectedMonth = parseInt(document.getElementById('filterBulan').value);
    const selectedYear = parseInt(document.getElementById('filterTahun').value);

    let totalPendapatan = 0;
    let totalHutang = 0;
    let totalTransaksi = 0;

    // Reset filtered array
    filteredDataArray = [];

    dataArray.forEach(item => {
        const itemDate = new Date(item.tanggal);

        // Cek apakah transaksi sesuai bulan & tahun yang dipilih
        if (itemDate.getMonth() === selectedMonth && itemDate.getFullYear() === selectedYear) {
            filteredDataArray.push(item); // Simpan untuk grafik & tabel
            totalTransaksi++;

            if (item.status === 'Bayar') {
                totalPendapatan += parseFloat(item.harga || 0);
            } else if (item.status === 'Hutang') {
                totalHutang += parseFloat(item.harga || 0);
            }
        }
    });

    // Update nilai statistik ke tampilan
    document.getElementById('totalPendapatan').textContent = formatRupiah(totalPendapatan);
    document.getElementById('totalHutang').textContent = formatRupiah(totalHutang);
    document.getElementById('totalTransaksi').textContent = totalTransaksi;

    // Update label statistik
    const monthName = getMonthName(selectedMonth);
    const currentDate = new Date();
    const isCurrentMonth = selectedMonth === currentDate.getMonth() && selectedYear === currentDate.getFullYear();

    if (isCurrentMonth) {
        document.getElementById('labelPendapatan').textContent = 'Pendapatan Bulan Ini';
        document.getElementById('labelHutang').textContent = 'Hutang Bulan Ini';
        document.getElementById('labelTransaksi').textContent = 'Transaksi Bulan Ini';
    } else {
        document.getElementById('labelPendapatan').textContent = `Pendapatan ${monthName} ${selectedYear}`;
        document.getElementById('labelHutang').textContent = `Hutang ${monthName} ${selectedYear}`;
        document.getElementById('labelTransaksi').textContent = `Transaksi ${monthName} ${selectedYear}`;
    }

    // 🟡 Penting: Update tabel & grafik berdasarkan data yang terfilter
    renderTable();            // Tabel akan pakai filteredDataArray
    createMonthlyChart();     // Grafik pakai filteredDataArray
    createPieJenisPaketChart(); // Tambahan untuk update pie chart

}

function showStatusList(status) {
  const selectedMonth = parseInt(document.getElementById('filterBulan').value);
  const selectedYear = parseInt(document.getElementById('filterTahun').value);

  const listContainer = document.getElementById('statusListContent');
  const modalTitle = document.getElementById('modalTitle');

  // Filter data sesuai status dan bulan/tahun
  const filtered = dataArray.filter(item => {
    const date = new Date(item.tanggal);
    return (
      date.getMonth() === selectedMonth &&
      date.getFullYear() === selectedYear &&
      item.status === status
    );
  });

  modalTitle.textContent = `Daftar Customer dengan Status "${status}"`;

  if (filtered.length === 0) {
    listContainer.innerHTML = `<p class="text-gray-500 text-center">Tidak ada data ${status.toLowerCase()} bulan ini.</p>`;
  } else {
    const listHTML = `
      <table class="w-full text-sm text-left border">
        <thead class="bg-gray-100 text-gray-600">
          <tr>
            <th class="py-2 px-3">No</th>
            <th class="py-2 px-3">Nama</th>
            <th class="py-2 px-3">Nomor HP</th>
            <th class="py-2 px-3">Jenis Paket</th>
            <th class="py-2 px-3">Harga</th>
            <th class="py-2 px-3">Tanggal</th>
          </tr>
        </thead>
        <tbody>
          ${filtered.map((item, i) => `
            <tr class="border-t">
              <td class="py-2 px-3">${i + 1}</td>
              <td class="py-2 px-3">${item.nama}</td>
              <td class="py-2 px-3">${item.nomorHP}</td>
              <td class="py-2 px-3">${item.jenisPaket || '-'}</td>
              <td class="py-2 px-3">${formatRupiah(item.harga)}</td>
              <td class="py-2 px-3">${new Date(item.tanggal).toLocaleDateString('id-ID')}</td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    `;
    listContainer.innerHTML = listHTML;
  }

  document.getElementById('statusListModal').classList.remove('hidden');
}

// Tutup modal saat tombol close ditekan
document.getElementById("closeStatusListModal").addEventListener("click", () => {
  document.getElementById("statusListModal").classList.add("hidden");
});

    function createMonthlyChart() {
  const ctx = document.getElementById('monthlyChart').getContext('2d');

  // Hapus chart lama jika ada
  if (monthlyChart) monthlyChart.destroy();

  const pembeliCounts = {};

  // Gunakan data yang sudah difilter berdasarkan bulan/tahun
  filteredDataArray.forEach(item => {
    const nama = item.nama;
    if (!pembeliCounts[nama]) pembeliCounts[nama] = 0;
    pembeliCounts[nama]++;
  });

  // Urutkan dan ambil 7 pembeli terbanyak
  const sorted = Object.entries(pembeliCounts)
    .sort((a, b) => b[1] - a[1])
    .slice(0, 7);

  const labels = sorted.map(([nama]) => nama);
  const data = sorted.map(([_, count]) => count);

  const colors = ['#3b82f6', '#f59e0b', '#10b981', '#ef4444', '#8b5cf6', '#ec4899', '#14b8a6'];

  monthlyChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [{
        label: 'Jumlah Pembelian',
        data: data,
        backgroundColor: colors,
        borderRadius: 6
      }]
    },
    options: {
      responsive: true,

      // ✅ Animasi
      animation: {
        duration: 1000,
        easing: 'easeOutBounce'
      },

      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: context => `${context.label}: ${context.parsed.y} pembelian`
          }
        },
        datalabels: {
          anchor: 'end',
          align: 'top',
          font: { weight: 'bold' },
          formatter: value => value
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          title: {
            display: true,
            text: 'Jumlah Pembelian',
            font: { size: 14, weight: 'bold' }
          }
        },
        x: {
          title: {
            display: true,
            text: 'Nama Pembeli',
            font: { size: 14, weight: 'bold' }
          }
        }
      }
    },
    plugins: [ChartDataLabels]
  });

  // Update label judul grafik
  const selectedMonth = parseInt(document.getElementById('filterBulan').value);
  const selectedYear = parseInt(document.getElementById('filterTahun').value);
  document.getElementById('chartYear').textContent = `Top 7 Pembeli - ${getMonthName(selectedMonth)} ${selectedYear}`;
}


        // ==========================================
        // FUNGSI UNTUK MENAMPILKAN STATUS MESSAGE
        // ==========================================
       function showStatus(message, type = 'success') {
    const statusDiv = document.getElementById('statusMessage');
    
    // Animasi masuk
    const bgColor = type === 'success' ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200';
    const textColor = type === 'success' ? 'text-green-800' : 'text-red-800';
    const icon = type === 'success' ? 'fa-check-circle text-green-500' : 'fa-exclamation-triangle text-red-500';
    
    statusDiv.className = `mb-6 p-4 rounded-lg border-2 ${bgColor} transform transition-all duration-500 ease-in-out`;
    statusDiv.innerHTML = `
        <div class="flex items-center animate-pulse">
            <i class="fas ${icon} mr-3 text-xl"></i>
            <div class="flex-1">
                <p class="font-semibold ${textColor}">${message}</p>
            </div>
            <button onclick="this.parentElement.parentElement.classList.add('hidden')" class="text-gray-400 hover:text-gray-600">
                <i class="fas fa-times"></i>
            </button>
        </div>
    `;
    
    // Tampilkan dengan animasi slide down
    statusDiv.classList.remove('hidden');
    statusDiv.style.opacity = '0';
    statusDiv.style.transform = 'translateY(-20px)';
    
    setTimeout(() => {
        statusDiv.style.opacity = '1';
        statusDiv.style.transform = 'translateY(0)';
    }, 10);
    
    // Auto hide setelah 4 detik dengan animasi fade out
    setTimeout(() => {
        statusDiv.style.opacity = '0';
        statusDiv.style.transform = 'translateY(-20px)';
        setTimeout(() => {
            statusDiv.classList.add('hidden');
        }, 500);
    }, 4000);
}

function tampilkanDaftarDashboard(status) {
  const selectedMonth = parseInt(document.getElementById('filterBulan').value);
  const selectedYear = parseInt(document.getElementById('filterTahun').value);

  const filtered = dataArray.filter(item => {
    const date = new Date(item.tanggal);
    return (
      date.getMonth() === selectedMonth &&
      date.getFullYear() === selectedYear &&
      item.status === status
    );
  });

  const listHTML = `
    <h3 class="text-lg font-semibold text-${status === 'Bayar' ? 'green' : 'red'}-700 mb-2">
      Daftar Customer ${status} Bulan Ini
    </h3>
    ${filtered.length === 0 ? '<p class="text-gray-500 text-sm">Tidak ada data.</p>' : `
      <table class="w-full text-sm text-left border">
        <thead class="bg-gray-100 text-gray-600">
          <tr>
            <th class="py-2 px-3">No</th>
            <th class="py-2 px-3">Nama</th>
            <th class="py-2 px-3">HP</th>
            <th class="py-2 px-3">Paket</th>
            <th class="py-2 px-3">Harga</th>
            <th class="py-2 px-3">Tanggal</th>
          </tr>
        </thead>
        <tbody>
          ${filtered.map((item, i) => `
            <tr class="border-t">
              <td class="py-2 px-3">${i + 1}</td>
              <td class="py-2 px-3">${item.nama}</td>
              <td class="py-2 px-3">${item.nomorHP}</td>
              <td class="py-2 px-3">${item.jenisPaket || '-'}</td>
              <td class="py-2 px-3">${formatRupiah(item.harga)}</td>
              <td class="py-2 px-3">${new Date(item.tanggal).toLocaleDateString('id-ID')}</td>
            </tr>`).join('')}
        </tbody>
      </table>
    `}
  `;

  if (status === 'Bayar') {
    document.getElementById('listBayarDashboard').innerHTML = listHTML;
    document.getElementById('listBayarDashboard').classList.remove('hidden');
    document.getElementById('listHutangDashboard').classList.add('hidden');
  } else {
    document.getElementById('listHutangDashboard').innerHTML = listHTML;
    document.getElementById('listHutangDashboard').classList.remove('hidden');
    document.getElementById('listBayarDashboard').classList.add('hidden');
  }
}

        // ==========================================
        // FUNGSI UNTUK RENDER TABEL
        // ==========================================
        function renderTable() {
            const tableBody = document.getElementById('dataTable');
            const loadingTable = document.getElementById('loadingTable');
            const tableContainer = document.getElementById('tableContainer');
            const noDataMessage = document.getElementById('noDataMessage');

            // Sembunyikan loading
            loadingTable.classList.add('hidden');

            if (filteredDataArray.length === 0) {
                tableContainer.classList.add('hidden');
                noDataMessage.classList.remove('hidden');
                return;
            }

            // Tampilkan tabel dan sembunyikan pesan kosong
            tableContainer.classList.remove('hidden');
            noDataMessage.classList.add('hidden');

            // Bersihkan tabel
            tableBody.innerHTML = '';

            // Render data
            filteredDataArray.forEach((item, index) => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 transition-colors duration-200';
                
                const statusClass = item.status === 'Bayar' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
                const statusIcon = item.status === 'Bayar' ? 'fa-check-circle' : 'fa-exclamation-triangle';
                
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${index + 1}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-medium text-gray-900">${item.nama}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item.nomorHP}</td>
                    
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item.jenisPaket || '-'}</td> <!-- ✅ Tambahan -->
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${formatRupiah(parseFloat(item.harga))}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${new Date(item.tanggal).toLocaleDateString('id-ID')}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${statusClass}">
                            <i class="fas ${statusIcon} mr-1"></i>
                            ${item.status}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2">
                        <button 
                            onclick="editData(${dataArray.indexOf(item)})" 
                            class="text-blue-600 hover:text-blue-900 transition-colors duration-200"
                            title="Edit"
                        >
                            <i class="fas fa-edit"></i>
                        </button>
                        <button 
                            onclick="deleteData(${dataArray.indexOf(item)})" 
                            class="text-red-600 hover:text-red-900 transition-colors duration-200"
                            title="Hapus"
                        >
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                
                tableBody.appendChild(row);
            });
        }
function exportToPDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();

  const rows = [];
  const tableRows = document.querySelectorAll("#dataTable tr");

  if (tableRows.length === 0) {
    alert("Tidak ada data untuk diekspor.");
    return;
  }

  let totalBayar = 0;
  let totalHutang = 0;
  let countBayar = 0;
  let countHutang = 0;

  tableRows.forEach((tr, index) => {
    const cells = tr.querySelectorAll("td");
    if (cells.length < 7) return;

    const nama = cells[1].innerText;
    const nomorHP = cells[2].innerText;
    const jenisPaket = cells[3].innerText;
    const hargaStr = cells[4].innerText.replace(/[^\d]/g, '');
    const harga = parseFloat(hargaStr || 0);
    const tanggal = cells[5].innerText;
    const status = cells[6].innerText.trim();

    rows.push([
      index + 1,
      nama,
      nomorHP,
      jenisPaket,
      cells[4].innerText,
      tanggal,
      status
    ]);

    if (status.includes("Bayar")) {
      totalBayar += harga;
      countBayar++;
    } else if (status.includes("Hutang")) {
      totalHutang += harga;
      countHutang++;
    }
  });

  const totalOrang = countBayar + countHutang;
  const totalSemua = totalBayar + totalHutang;

  doc.setFontSize(14);
  doc.text("Laporan Pembelian Paket Data", 14, 15);

  doc.autoTable({
    head: [["No", "Nama", "Nomor HP", "Jenis Paket", "Harga", "Tanggal", "Status"]],
    body: rows,
    startY: 20,
    theme: 'striped'
  });

  const akhirY = doc.lastAutoTable.finalY + 10;
  doc.setFontSize(12);
  doc.text("Rekapitulasi:", 14, akhirY);
  doc.setFontSize(11);
  doc.text(`- Total Bayar: ${countBayar} orang (${formatRupiah(totalBayar)})`, 14, akhirY + 8);
  doc.text(`- Total Hutang: ${countHutang} orang (${formatRupiah(totalHutang)})`, 14, akhirY + 16);
  doc.text(`- Total Transaksi: ${totalOrang} orang`, 14, akhirY + 24);
  doc.text(`- Total Nilai Transaksi: ${formatRupiah(totalSemua)}`, 14, akhirY + 32);

  const tanggalExport = new Date().toISOString().slice(0, 10);
  doc.save(`laporan-paket-${tanggalExport}.pdf`);
}

        // ==========================================
        // FUNGSI UNTUK PENCARIAN
        // ==========================================
      function performSearch() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
    const clearButton = document.getElementById('clearSearch');
    const searchResults = document.getElementById('searchResults');
    const searchCount = document.getElementById('searchCount');
    const searchAll = document.getElementById('searchAll').checked;

    const targetArray = searchAll ? dataArray : filteredDataArray;

    // Buat ulang isi tabel berdasarkan hasil pencarian
    const tableBody = document.getElementById('dataTable');
    tableBody.innerHTML = '';
    let count = 0;

    targetArray.forEach((item, index) => {
        const nama = item.nama?.toLowerCase() || '';
        const hp = item.nomorHP || '';
        if (nama.includes(searchTerm) || hp.includes(searchTerm)) {
            count++;

            const row = document.createElement('tr');
            const statusClass = item.status === 'Bayar' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
            const statusIcon = item.status === 'Bayar' ? 'fa-check-circle' : 'fa-exclamation-triangle';

            row.innerHTML = `
                <td class="px-6 py-4">${index + 1}</td>
                <td class="px-6 py-4">${item.nama}</td>
                <td class="px-6 py-4">${item.nomorHP}</td>
                <td class="px-6 py-4">${item.jenisPaket || '-'}</td>
                <td class="px-6 py-4">${formatRupiah(parseFloat(item.harga))}</td>
                <td class="px-6 py-4">${new Date(item.tanggal).toLocaleDateString('id-ID')}</td>
                <td class="px-6 py-4">
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${statusClass}">
                        <i class="fas ${statusIcon} mr-1"></i> ${item.status}
                    </span>
                </td>
                <td class="px-6 py-4">
                    <button onclick="editData(${dataArray.indexOf(item)})" class="text-blue-600"><i class="fas fa-edit"></i></button>
                    <button onclick="deleteData(${dataArray.indexOf(item)})" class="text-red-600 ml-2"><i class="fas fa-trash"></i></button>
                </td>
            `;
            tableBody.appendChild(row);
        }
    });

    if (searchTerm === '') {
        clearButton.classList.add('hidden');
        searchResults.classList.add('hidden');
        calculateFilteredStats(); // Kembalikan tampilan normal
    } else {
        clearButton.classList.remove('hidden');
        searchResults.classList.remove('hidden');
        searchCount.textContent = count;
    }
}



        // ==========================================
        // FUNGSI UNTUK CLEAR PENCARIAN
        // ==========================================
        function clearSearch() {
            document.getElementById('searchInput').value = '';
            performSearch();
        }
function deleteData(index) {
    const item = dataArray[index];
    if (!item || !item.key) return;

    if (confirm(`Yakin ingin menghapus data atas nama ${item.nama}?`)) {
        db.ref("pembelian/" + item.key).remove()
            .then(() => {
                showStatus("🗑️ Data berhasil dihapus", "success");
                loadDataFromFirebase();
            })
            .catch((error) => {
                showStatus("❌ Gagal menghapus data: " + error.message, "error");
            });
    }
}

        // ==========================================
        // FUNGSI UNTUK EDIT DATA
        // ==========================================
     function editData(index) {
    editingIndex = index;
    const item = dataArray[index];

    // Isi modal
    document.getElementById('editNama').textContent = item.nama;
    document.getElementById('editNomorHP').textContent = item.nomorHP;
    document.getElementById('editHarga').textContent = formatRupiah(parseFloat(item.harga));
    document.getElementById('editStatus').value = item.status;

    // Tampilkan modal
    document.getElementById('editModal').classList.remove('hidden');
}

// Fungsi untuk menyimpan hasil edit status ke Firebase
document.getElementById("saveEdit").addEventListener("click", () => {
    if (editingIndex < 0) return;

    const item = dataArray[editingIndex];
    const newStatus = document.getElementById("editStatus").value;

    db.ref("pembelian/" + item.key).update({ status: newStatus })
        .then(() => {
            showStatus("✅ Status berhasil diperbarui", "success");
            document.getElementById("editModal").classList.add("hidden");
            loadDataFromFirebase();
        })
        .catch((error) => {
            showStatus("❌ Gagal memperbarui status: " + error.message, "error");
        });
});

// Fungsi untuk membatalkan edit

document.getElementById("cancelEdit").addEventListener("click", () => {
    document.getElementById("editModal").classList.add("hidden");
});

document.getElementById("closeModal").addEventListener("click", () => {
    document.getElementById("editModal").classList.add("hidden");
});
//antar halaman
function showSection(section) {
    document.getElementById('dashboardSection').style.display = (section === 'dashboard') ? 'block' : 'none';
    document.getElementById('dataSection').style.display = (section === 'data') ? 'block' : 'none';
    
    // ✅ Render chart ketika pindah ke halaman data
    if (section === 'data') {
        setTimeout(() => {
            updateChart(dataArray);
        }, 100); // Delay sedikit untuk memastikan DOM sudah ter-render
    }
}


function loadDataFromFirebase(callback) {
  db.ref("pembelian").once("value").then(snapshot => {
    dataArray = [];
    snapshot.forEach(child => {
      dataArray.push({ ...child.val(), key: child.key });
    });
    calculateFilteredStats(); // untuk update statistik
    if (typeof callback === 'function') {
      callback(); // ini untuk menunggu sebelum tampilkan modal
    }
  });
}

document.getElementById("formPaketData").addEventListener("submit", function(e) {
    e.preventDefault();

    // Tampilkan loading state
    const btnSubmit = document.getElementById("btnSubmit");
    const btnText = document.getElementById("btnText");
    const btnLoading = document.getElementById("btnLoading");
    
    // Disable button dan tampilkan loading
    btnSubmit.disabled = true;
    btnSubmit.classList.add("cursor-not-allowed", "opacity-75");
    btnText.classList.add("hidden");
    btnLoading.classList.remove("hidden");

    const nama = document.getElementById("nama").value;
    const nomorHP = document.getElementById("nomorHP").value;
    const jenisPaket = document.getElementById("jenisPaket").value;
    const harga = document.getElementById("harga").value;
    const tanggal = document.getElementById("tanggalPembelian").value;
    const status = document.getElementById("statusPembayaran").value;

    const newData = {
        nama,
        nomorHP,
        jenisPaket,
        harga,
        tanggal,
        status
    };

    const newKey = db.ref().child("pembelian").push().key;
    
    // Simulasi delay minimum untuk UX yang lebih baik
    const minDelay = new Promise(resolve => setTimeout(resolve, 1000));
    const firebasePromise = db.ref("pembelian/" + newKey).set(newData);
    
    Promise.all([minDelay, firebasePromise])
        .then(() => {
            // Reset button state
            resetButtonState();
            
            // Tampilkan success dengan confetti effect
            showStatus("🎉 Data berhasil disimpan! Selamat, transaksi baru telah ditambahkan.", "success");
            
            // Reset form dengan animasi
            document.getElementById("formPaketData").reset();
            
            // Refresh data
            loadDataFromFirebase();
            
            // Scroll ke atas untuk melihat notifikasi
            window.scrollTo({ top: 0, behavior: 'smooth' });
        })
        .catch((error) => {
            resetButtonState();
            showStatus(`❌ Oops! Gagal menyimpan data: ${error.message}`, "error");
        });
    function resetButtonState() {
        btnSubmit.disabled = false;
        btnSubmit.classList.remove("cursor-not-allowed", "opacity-75");
        btnText.classList.remove("hidden");
        btnLoading.classList.add("hidden");
    }
});

let pieJenisChart = null;

function createPieJenisPaketChart() {
  const ctx = document.getElementById('pieJenisPaketChart').getContext('2d');

  // Hapus chart lama kalau ada
  if (pieJenisChart) pieJenisChart.destroy();

  let vpn = 0;
  let reguler = 0;

  filteredDataArray.forEach(item => {
    if (item.jenisPaket === 'VPN') vpn++;
    else if (item.jenisPaket === 'Reguler') reguler++;
  });

  pieJenisChart = new Chart(ctx, {
    type: 'pie',
    data: {
      labels: ['VPN', 'Reguler'],
      datasets: [{
        data: [vpn, reguler],
        backgroundColor: ['#3b82f6', '#f472b6'], // Biru & Pink
        borderWidth: 0
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: {
          position: 'bottom',
          labels: {
            color: '#374151',
            font: { weight: 'bold' }
          }
        },
        tooltip: {
          callbacks: {
            label: context => `${context.label}: ${context.parsed} pembelian`
          }
        }
      }
    }
  });
}

   document.getElementById("searchInput").addEventListener("input", performSearch);
document.getElementById("clearSearch").addEventListener("click", clearSearch);
</script>

</body>
</html>
